# Antigravity Manager → gcli2api 凭证导出脚本

## 任务描述

编写 Python 脚本，将 Antigravity Manager 的账号凭证转换为 gcli2api 项目可用的 JSON 格式文件。

## 需求确认

- **导出方式**：导出为 JSON 文件（用户通过 gcli2api Web 界面手动上传）
- **凭证选择**：导出所有账号凭证
- **安全性**：不加密，导出到 `~/Downloads/antigravity_creds_export/`，不生成日志
- **执行环境**：Python 脚本（独立运行）

## 技术方案

### 数据源（Antigravity Manager）

**存储位置**：`~/.antigravity_tools/accounts/`

**账号索引文件**：`~/.antigravity_tools/accounts.json`
```json
{
  "version": "2.0",
  "accounts": [
    {
      "id": "uuid",
      "email": "user@gmail.com",
      "name": "账号名称",
      "created_at": 1736833276,
      "last_used": 1737094245
    }
  ],
  "current_account_id": "uuid"
}
```

**账号详细数据**：`~/.antigravity_tools/accounts/{id}.json`
```json
{
  "id": "uuid",
  "email": "user@gmail.com",
  "name": "账号名称",
  "token": {
    "access_token": "ya29...",
    "refresh_token": "1//...",
    "expires_in": 3599,
    "expiry_timestamp": 1737097845,
    "token_type": "Bearer",
    "email": "user@gmail.com",
    "project_id": "projects/xxx/locations/global",
    "session_id": "optional"
  },
  "quota": {...},
  "created_at": 1736833276,
  "last_used": 1737094245
}
```

### 目标格式（gcli2api）

**凭证文件格式**：
```json
{
  "client_id": "77185425430.apps.googleusercontent.com",
  "client_secret": "GOCSPX-...",
  "token": "ya29...",
  "refresh_token": "1//...",
  "scopes": ["https://www.googleapis.com/auth/cloud-platform"],
  "token_uri": "https://oauth2.googleapis.com/token",
  "project_id": "projects/xxx/locations/global",
  "expiry": "2026-01-17T02:30:45+00:00"
}
```

### 数据转换映射

| Antigravity Manager | gcli2api | 说明 |
|---------------------|----------|------|
| token.access_token | token | 访问令牌 |
| token.refresh_token | refresh_token | 刷新令牌 |
| token.project_id | project_id | 项目 ID |
| token.expiry_timestamp | expiry | 时间戳转 ISO 8601 |
| [常量] | client_id | 固定值 |
| [常量] | client_secret | 固定值 |
| [常量] | scopes | 固定值 |
| [常量] | token_uri | 固定值 |

## 实施步骤

### 步骤 1：创建脚本文件
- 文件：`scripts/export_antigravity_creds.py`
- 添加 shebang 和文件头注释

### 步骤 2：配置常量区
- Antigravity OAuth 配置（CLIENT_ID、CLIENT_SECRET、SCOPES）
- 文件路径配置
- Token URI

### 步骤 3：数据读取模块
- `get_data_dir()`: 获取数据目录
- `load_account_index()`: 读取索引
- `load_account()`: 加载账号数据

### 步骤 4：数据转换模块
- `convert_timestamp_to_iso()`: 时间戳转换
- `validate_token()`: Token 验证
- `convert_to_gcli2api_format()`: 格式转换

### 步骤 5：文件导出模块
- `ensure_export_dir()`: 创建导出目录
- `sanitize_filename()`: 文件名清理
- `export_credential()`: 导出凭证

### 步骤 6：主流程控制
- 读取所有账号
- 批量转换
- 统计结果
- 输出报告

### 步骤 7：命令行参数
- `--output-dir`: 自定义导出目录
- `--dry-run`: 试运行
- `--verbose`: 详细输出

### 步骤 8：错误处理
- 文件不存在处理
- JSON 解析错误处理
- 权限错误处理

### 步骤 9：文档注释
- Docstring
- 使用说明
- 示例

## 预期成果

执行脚本后：
- 在 `~/Downloads/antigravity_creds_export/` 目录生成 JSON 文件
- 文件命名：`antigravity_{email}.json`
- 控制台输出友好的执行报告
- 包含成功/失败统计

## 使用方式

```bash
# 基本使用
python scripts/export_antigravity_creds.py

# 自定义输出目录
python scripts/export_antigravity_creds.py --output-dir /path/to/output

# 试运行（不写入文件）
python scripts/export_antigravity_creds.py --dry-run

# 详细输出
python scripts/export_antigravity_creds.py --verbose
```

## 后续步骤

1. 执行脚本导出凭证文件
2. 打开 gcli2api Web 界面：`http://127.0.0.1:7861/auth`
3. 进入"批量上传"标签页（Antigravity 部分）
4. 上传导出的 JSON 文件
